<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ title }}</title>
  <link rel="icon" href="https://aayana.com.np/wp-content/uploads/2024/08/cropped-Group-1-32x32.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="https://aayana.com.np/wp-content/uploads/2024/08/cropped-Group-1-180x180.png" />
  <meta name="msapplication-TileImage" content="https://aayana.com.np/wp-content/uploads/2024/08/cropped-Group-1-270x270.png" />
  <base href="https://aayana.com.np/ThermoComfortMaps/" />

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    
    #map-container {
      position: relative;
      display: inline-block;
      width: 100%;          /* Full width on mobile */
      max-width: 800px;     /* Optional: limit on desktop */
    }
    
    #floor-map {
      max-width: 100%;
      height: auto;
      display: block;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .marker {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .hot { background-color: rgb(250, 91, 43); }
    .warm { background-color: rgb(255, 165, 0); }
    .ideal { background-color: rgb(121, 245, 121); }
    .cool { background-color: rgb(67, 122, 224); }
    .cold { background-color: rgb(20, 204, 250); }

    /* Buttons / icons should scale */
    .temp-btn, .clothing-btm, .lighting-btm {
      width: 60px;      /* slightly bigger touch area */
      height: 60px;
      margin: 8px;
    }
    /* Center text & allow wrapping */
    .buttons, .clothing, .lighting {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .temp-btn:hover {
      transform: scale(1.1);
    }

    .buttons {
      margin-bottom: 10px;
    }
    button {
      margin: 5px;
      padding: 10px;
      cursor: pointer;
    }
  </style>

  <!-- Injected room data -->
  <script>
    const rooms = {{ rooms | tojson }};
  </script>

  <!-- Helper function -->
  <script>
    function pointInPolygon(point, vs) {
      const x = point[0], y = point[1];
      let inside = false;
      for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        const xi = vs[i][0], yi = vs[i][1];
        const xj = vs[j][0], yj = vs[j][1];
        const intersect = ((yi > y) != (yj > y)) &&
          (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }
  </script>
</head>
<body>
  <h2>How do you feel? Mark your spot on the map of your room.</h2>
  <div class="buttons">
    <img src="static/images/hot-thermo.png" alt="hot" class="temp-btm" onclick="setMarkerType('hot')">
    <img src="static/images/ideal-thermo.png" alt="ideal" class="temp-btm" onclick="setMarkerType('ideal')">
    <img src="static/images/cold-thermo.png" alt="cold" class="temp-btm" onclick="setMarkerType('cold')">
    <a href="{{ form_url }}" target="_blank" style="text-decoration: none;">
    <button style="background: rgb(255, 64, 64); color: white;">Share Other Concern</button>
  </a>
  </div>
  
  <div class="map-container" id="map-container">
    <img src="{{ image }}" id="floor-map" alt="Floor Map" />
    <svg id="overlay"></svg>
     <!-- Trash can button -->
    <img src="trash-icon.png" 
       id="delete-marker-btn" 
       style="position:absolute; top:10px; right:10px; width:40px; height:40px; cursor:pointer; z-index:10;" 
       title="Delete selected marker">
  </div>

  <h2>What best describes your clothing?.</h2>
  <div class="clothing">
    <img src="static/images/jacket.png" alt="heavy" class="clothing-btm" onclick="setClothing('heavy', event)">
    <img src="static/images/sweatshirt.png" alt="medium" class="clothing-btm" onclick="setClothing('medium', event)">
    <img src="static/images/tshirt.png" alt="light" class="clothing-btm" onclick="setClothing('light', event)">
  </div>

  <h2>What best describes natural light?.</h2>
  <div class="lighting">
    <img src="static/images/sun.png" alt="sunny" class="lighting-btm" onclick="setLighting('sunny', event)">
    <img src="static/images/cloud.png" alt="cloudy" class="lighting-btm" onclick="setLighting('cloudy', event)">
    <img src="static/images/moon.png" alt="night" class="lighting-btm" onclick="setLighting('night', event)">
    <img src="static/images/no-window.png" alt="no window" class="lighting-btm" onclick="setLighting('no_window', event)">
  </div>

  <script>
    let selectedMarkerType = 'ideal';
    let selectedClothing = null;
    let selectedLighting = null;
    let markers = [];
    let selectedMarker = null;
    const mapImage = document.getElementById("floor-map");
    const overlay = document.getElementById("overlay");
    const container = document.getElementById("map-container");

    function setMarkerType(type) {
      selectedMarkerType = type;
    }

    function setClothing(type, event) {
      selectedClothing = type;
      // Optional: highlight selected image
      document.querySelectorAll('.clothing-btm').forEach(img => img.style.border = '');
      event.target.style.border = "2px solid black";
    }

    function setLighting(type, event) {
      selectedLighting = type;
      // Optional: highlight selected image
      document.querySelectorAll('.lighting-btm').forEach(img => img.style.border = '');
      event.target.style.border = "2px solid black";
    }

    // Create a marker
    function createMarker(xPercent, yPercent, type, room_id, fromSupabase=false) {
      // Remove existing marker in room
      const existing = markers.find(m => m.room_id === room_id);
      if (existing) {
        existing.element.remove();
        markers = markers.filter(m => m.room_id !== room_id);
      }
    
    const marker = document.createElement('div');
    marker.className = `marker ${type}`;
    marker.style.left = `${xPercent}%`;
    marker.style.top = `${yPercent}%`;

    // Select marker on click
    marker.addEventListener('click', (e) => {
      e.stopPropagation();
      if (selectedMarker) selectedMarker.style.border = '';
      selectedMarker = marker;
      selectedMarker.style.border = '2px solid black'; // highlight selected
    });

    if (!fromSupabase) marker.timestamp = Date.now();

    container.appendChild(marker);

    markers.push({
      x: xPercent,
      y: yPercent,
      type,
      room_id,
      element: marker,
      timestamp: marker.timestamp || Date.now()
    });
  }

  // Click trash can to delete selected marker
  document.getElementById('delete-marker-btn').addEventListener('click', () => {
    if (selectedMarker) {
      markers = markers.filter(m => m.element !== selectedMarker);
      selectedMarker.remove();
      selectedMarker = null;
    } else {
      alert("Select a marker first to delete it.");
    }
  });
    // Place marker on map click
    container.addEventListener('click', function (event) {
      if (event.target.tagName !== 'floor_map') return;

      const rect = mapImage.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const clickY = event.clientY - rect.top;

      let clickedRoom = null;
      for (const room of rooms) {
        if (pointInPolygon([clickX, clickY], room.polygon.map(([x, y]) => [
          x * (mapImage.clientWidth / mapImage.naturalWidth),
          y * (mapImage.clientHeight / mapImage.naturalHeight)
        ]))) {
          clickedRoom = room.id;
          break;
        }
      }

      if (!clickedRoom) {
        alert("Click inside a defined room area.");
        return;
      }

      const xPercent = (clickX / rect.width) * 100;
      const yPercent = (clickY / rect.height) * 100;

      createMarker(xPercent, yPercent, selectedMarkerType, clickedRoom);
    });

    function saveMarkers() {
      const userId = localStorage.getItem("userId") || crypto.randomUUID();
      localStorage.setItem("userId", userId); 
        
      const markerData = markers.map(m => ({
        x: m.x,
        y: m.y,
        type: m.type,
        room_id: m.room_id,
        timestamp: m.timestamp
      }));
      
      fetch("/ThermoComfortMaps/submit-markers", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          user_id: userId,
          location: "{{ location }}",
          markers: markerData,
          clothing: selectedClothing,
          lighting: selectedLighting
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            console.error("Server error:", text);
            alert("Failed to save markers.");
        });
       } else {
          alert("Markers saved successfully!");
        }
      })
      .catch(err => alert("Error: " + err));
    }

    // --- Load existing markers ---
window.addEventListener('load', () => {
  const userId = localStorage.getItem("userId") || crypto.randomUUID();
  localStorage.setItem("userId", userId);

  fetch(`/ThermoComfortMaps/get-markers/{{ location }}/` + userId)
    .then(res => res.json())
    .then(markerList => {
      if (!Array.isArray(markerList)) return;
      markerList.forEach(({ x, y, type, room_id }) => {
        createMarker(x, y, type, room_id, true);
      });
    })
    .catch(err => console.error("Failed to load markers:", err));
});
</script>
</body>
</html>