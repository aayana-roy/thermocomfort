<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ title }}</title>
  <link rel="icon" href="https://aayana.com.np/wp-content/uploads/2024/08/cropped-Group-1-32x32.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="https://aayana.com.np/wp-content/uploads/2024/08/cropped-Group-1-180x180.png" />
  <meta name="msapplication-TileImage" content="https://aayana.com.np/wp-content/uploads/2024/08/cropped-Group-1-270x270.png" />
  <base href="https://aayana.com.np/ThermoComfortMaps/" />

  <style>
    body {
      font-family: Arial, sans-serif;
      color: #333333;                 /* dark gray, easier on eyes */
      background-color: #f9f9f9;      /* light background */
      text-align: left;
      line-height: 1;
      padding: 3px;
    }

    .card {
      background-color: white;
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .card h3 {
      margin-top: 0;
      color: #2a7ae2;
    }

    .card h5 {
      margin-top: 0;
      color: #3766a2;
    }

    .card p {
      color: #555555;
      margin-bottom: 8px;
    }

    /* Buttons inside cards */
    .card .buttons {
      justify-content: flex-start; /* or center if you like */
    }
    
    #map-container {
      position: relative;
      display: inline-block;
      width: 100%;          /* Full width on mobile */
      max-width: 600px;     /* Optional: limit on desktop */
    }
    
    #floor-map {
      max-width: 100%;
      height: auto;
      display: block;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .marker {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      z-index: 5;
    }
    .hot { background-color: rgb(250, 91, 43); }
    .warm { background-color: rgb(255, 165, 0); }
    .ideal { background-color: rgb(121, 245, 121); }
    .cool { background-color: rgb(67, 122, 224); }
    .cold { background-color: rgb(20, 204, 250); }

    /* Buttons / icons should scale */
    .temp-btm {
      width: 90px;
      height: 90px;
      margin: 8px;
    }

    /* Buttons / icons should scale */
    .clothing-btm {
      width: 90px;      /* slightly bigger touch area */
      height: 90px;
      margin: 8px;
    }

    .lighting-btm {
      width: 55px;
      height: 55px;
      margin: 8px;
    }

    .buttons {
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      margin-bottom: 5px;
      gap: 5px;
    }

    /* Center text & allow wrapping */
    .clothing, .lighting {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    button {
      margin: 5px;
      padding: 8px;
      cursor: pointer;
    }
  </style>
  {# 
    <!-- Injected room data -->
    <script>
      const rooms = {{ rooms | tojson }};
    </script>

    <!-- Helper function -->
    <script>
      function pointInPolygon(point, vs) {
        const x = point[0], y = point[1];
        let inside = false;
        for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
          const xi = vs[i][0], yi = vs[i][1];
          const xj = vs[j][0], yj = vs[j][1];
          const intersect = ((yi > y) != (yj > y)) &&
            (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }
    </script>
  #}
</head>
<body>
  <!-- Temperature -->
  <div class="card">
    <h3>How do you feel?</h3>
    <h5>Select a temperature marker and tap on the map to locate yourself.</h5>
    <div class="buttons">
      <button onclick="setMarkerType('hot', event)" style="background: red; color: white;">Too Hot</button>
      <button onclick="setMarkerType('warm', event)" style="background: orange; color: white;">Warm</button>
      <button onclick="setMarkerType('ideal', event)" style="background: green; color: white;">Ideal</button>
      <button onclick="setMarkerType('cool', event)" style="background: cornflowerblue; color: white;">Cool</button>
      <button onclick="setMarkerType('cold', event)" style="background: blue; color: white;">Too Cold</button>
    </div>
    <div class="map-container" id="map-container">
      <img src="{{ image }}" id="floor-map" alt="Floor Map" />
      <svg id="overlay"></svg>
      <!-- Trash can button -->
      <img src="static/images/trash-icon.png" 
        id="delete-marker-btn" 
        style="position:absolute; top:10px; right:10px; width:40px; height:40px; cursor:pointer; z-index:10;" 
        title="Delete selected marker">
    </div>
  </div>

  <!-- CLothing -->
  <div class="card">
    <h3>What best describes your clothing?</h3>
    <div class="clothing">
      <img src="static/images/tshirt.png" alt="light" class="clothing-btm" onclick="setClothing('light', event)">
      <img src="static/images/sweatshirt.png" alt="medium" class="clothing-btm" onclick="setClothing('medium', event)">
      <img src="static/images/jacket.png" alt="heavy" class="clothing-btm" onclick="setClothing('heavy', event)"> 
    </div>
  </div>

  <!-- Lighting -->
  <div class="card">
  <h3>What best describes natural light?</h3>
  <div class="lighting">
    <img src="static/images/no-window.png" alt="no window" class="lighting-btm" onclick="setLighting('no_window', event)">
    <img src="static/images/sun.png" alt="sunny" class="lighting-btm" onclick="setLighting('sunny', event)">
    <img src="static/images/cloud.png" alt="cloudy" class="lighting-btm" onclick="setLighting('cloudy', event)">
    <img src="static/images/moon.png" alt="night" class="lighting-btm" onclick="setLighting('night', event)">
  </div>
  </div>

  <!-- Save section -->
  <div class="buttons">
    <a href="{{ form_url }}" target="_blank" style="text-decoration: none;">
    <button style="background: #c5bebe; color: #333333;">Share Other Concern</button>
  </a>
    <button onclick="saveMarkers()" style="background: #9B0000; color: #FFFFFF;">Save My Feedback</button>
  </div>

  <script>
    let selectedMarkerType = 'ideal';
    let selectedClothing = null;
    let selectedLighting = null;
    let markers = [];
    let selectedMarker = null;
    const mapImage = document.getElementById("floor-map");
    const overlay = document.getElementById("overlay");
    const container = document.getElementById("map-container");

    function setMarkerType(type, event) {
      selectedMarkerType = type;
      document.querySelectorAll('.temp-btm').forEach(img => img.style.border = '');
      event.target.style.border = "2px solid black";
    }

    function setClothing(type, event) {
      selectedClothing = type;
      // Optional: highlight selected image
      document.querySelectorAll('.clothing-btm').forEach(img => img.style.border = '');
      event.target.style.border = "2px solid black";
    }

    function setLighting(type, event) {
      selectedLighting = type;
      // Optional: highlight selected image
      document.querySelectorAll('.lighting-btm').forEach(img => img.style.border = '');
      event.target.style.border = "2px solid black";
    }

    // Create a marker
    function createMarker(xPercent, yPercent, type, fromSupabase=false, clothing=null, lighting=null) {
      // Remove any existing marker (only 1 allowed now)
      if (markers.length > 0) {
        markers[0].element.remove();
        markers = [];
      }
    
    const marker = document.createElement('div');
    marker.className = `marker ${type}`;
    marker.style.left = `${xPercent}%`;
    marker.style.top = `${yPercent}%`;

    // Select marker on click
    marker.addEventListener('click', (e) => {
      e.stopPropagation();
      if (selectedMarker) selectedMarker.style.border = '';
      selectedMarker = marker;
      selectedMarker.style.border = '2px solid black'; // highlight selected
    });

    if (!fromSupabase) marker.timestamp = Date.now();

    container.appendChild(marker);

    markers.push({
      x: xPercent,
      y: yPercent,
      type,
      element: marker,
      timestamp: marker.timestamp || Date.now(),
      clothing: fromSupabase ? clothing : (selectedClothing || null),
      lighting: fromSupabase ? lighting : (selectedLighting || null)
    });
  }

    // Place marker on map click
    container.addEventListener('click', function (event) {
      if (event.target.tagName !== 'IMG') return;

      const rect = mapImage.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const clickY = event.clientY - rect.top;

      const xPercent = (clickX / rect.width) * 100;
      const yPercent = (clickY / rect.height) * 100;

      createMarker(xPercent, yPercent, selectedMarkerType);
    });

    // Click trash can to delete selected marker
    document.getElementById('delete-marker-btn').addEventListener('click', ()=>{
      if(confirm("Delete all markers? This cannot be undone.")){
        const userId = localStorage.getItem("userId");
        if(!userId){ alert("No markers to delete."); return; }
        markers.forEach(m=>m.element.remove()); markers=[]; selectedMarker=null;
        fetch(`/ThermoComfortMaps/delete-markers/{{ location }}/${userId}`,{method:"DELETE"})
        .then(response=> {
          if(response.ok) {
            alert("All markers deleted successfully!");
          } else
          throw new Error("Delete failed");
        })
        .catch(err=>alert("Error deleting markers: "+err));
      }
    });

    // Save markers to server
    function saveMarkers() {
      const userId = localStorage.getItem("userId") || crypto.randomUUID();
      localStorage.setItem("userId", userId); 
        
      const markerData = markers.map(m => ({
        x: m.x,
        y: m.y,
        type: m.type,
        timestamp: m.timestamp,
        clothing: m.clothing,
        lighting: m.lighting
      }));
      
      fetch("/ThermoComfortMaps/submit-markers", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          user_id: userId,
          location: "{{ location }}",
          markers: markerData
        })
      })
      .then(response => {
        if(response.ok) {
          alert("Markers saved successfully!");
        } else {
          return response.text().then(text=> {
            console.error("Server error:", text);
            alert("Failed to save markers.");
          });
        }
      })
      .catch(err => alert("Error: " + err));
    }

    // Load existing markers
    window.addEventListener('load', () => {
      const userId = localStorage.getItem("userId") || crypto.randomUUID();
      localStorage.setItem("userId", userId);

      fetch(`/ThermoComfortMaps/get-markers/{{ location }}/` + userId)
        .then(res => res.json())
        .then(markerList => {
          if (!Array.isArray(markerList)) return;
          markerList.forEach(({ x, y, type, clothing, lighting }) => {
            createMarker(x, y, type, true, clothing, lighting);
          });
        })
        .catch(err => console.error("Failed to load markers:", err));
    });
</script>
</body>
</html>